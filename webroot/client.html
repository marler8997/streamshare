<html><head>
<title>Stream Share</title>
<style type="text/css">
* {margin:0;padding:0}
body {background:#000;color:#aaa;font-family:arial;}
#EventSourceStatusDiv {
  font-weight: bold;
}
#ErrorDiv{
  color:#a00;
  margin:0 20px;
  text-align:center;
}
#StageDiv{
  text-align:center;
}
#StageContentDiv{
  display:inline-block;
}
#YoutubePlayerDiv{display:none}
</style>
<script src="https://www.youtube.com/iframe_api"></script>
<script>
function get(id) { return document.getElementById(id); }

function panic(msg) {
  let msgDiv = document.createElement('div');
  msgDiv.innerHTML = '<pre>Error: ' + msg + '</pre>';
  get('ErrorDiv').appendChild(msgDiv);
  throw msg;
}
function assert(cond, msg) {
  if (!cond) panic(msg);
}

// this function is called by the youtube iframe api library
function onYouTubeIframeAPIReady() {
  console.log("onYoutubeIframeAPIReady");
  onJavascriptReady();
}

var currentEventHandler = null;

var youtube = (function() {
  function loadVideo() {
    assert(youtube.current.event != null);
    get('YoutubePlayerDiv').style.display = 'inline-block';
    let start = 0;
    let event = youtube.current.event;
    if (event.seconds_since > 10) {
        start = Math.floor(event.seconds_since);
    }
    console.log("youtube v=" + event.data.v + " start=" + start);

    //
    // for some reason, loadVideoById doesn't work.  If a video is loaded that was previously
    // playing, then the startSeconds parameter is ignored
    //
    //youtube._player.loadVideoById({'videoId':event.data.v,'startSeconds':start});
    //youtube._player.loadVideoById(event.data.v, start);
    youtube._player.cueVideoById(event.data.v, start);
    youtube._player.seekTo(start);
    youtube._player.playVideo();

    setTimeout(retryPlay, 1000, event);
  }
  function retryPlay(event) {
    if (event !== youtube.current.event)
      return;
    if (youtube._player.getPlayerState() == YT.PlayerState.PLAYING) {
      console.log("retryPlay: done");
    } else {
      console.log("retryPlay");
      youtube._player.playVideo();
      setTimeout(retryPlay, 1000, event);
    }
  }
  function onReady(event) {
    console.log("youtube.onReady");
    assert(!youtube._playerReady, "youtube.onReady called but already ready");
    youtube._playerReady = true;
    // event could be null if another type of event was loaded before the player became ready
    if (youtube.current.event != null) {
      loadVideo();
    }
  }
  // for now this is just for debug logging
  function onStateChange(event) {
    if (event.data == -1) {
      console.log("youtube.onStateChange: -1 (unstarted)");
    } else if (event.data == YT.PlayerState.BUFFERING) {
      console.log("youtube.onStateChange: " + event.data + " (buffering)");
    } else if (event.data == YT.PlayerState.PLAYING) {
      console.log("youtube.onStateChange: " + event.data + " (playing)");
    } else {
      console.log("youtube.onStateChange: " + event.data)
    }
  }


return {

  "_player":null,
  "_playerReady":false,
  "current": null,

  "disable": function disableYoutube(event) {
    if (youtube._playerReady) {
      assert(youtube._player !== null, "youtube player ready but is null");
      youtube._player.stopVideo();
    }
    youtube.current = null;
    get('YoutubePlayerDiv').style.display = 'none';
  },
  "handleEvent": function handleYoutubeEvent(event) {
    youtube.current = {'event':event};

    if (youtube._playerReady) {
      assert(youtube._player !== null, "youtube player ready but is null");
      loadVideo();
      return;
    }
    // could be non-null because multiple events could come in before player is ready
    if (youtube._player === null) {
      youtube._player = new YT.Player('YoutubePlayerDiv', {
        'height': '390',
        'width': '640',
        'events': {
          'onReady': onReady,
          'onStateChange': onStateChange
        },
        'playerVars':{'autoplay':1}
        });
    }
  }

};

})();

var stopHandler = (function() {
return {
  "disable": function stopHandlerDisable() {
    // do nothing
  },
  "handleEvent": function stopHandlerHandleEvent(event) {
    // do nothing
  }
};

})();

// This is called once all javascript libraries have been loaded
// currently the only library we are waiting for is the youtube iframe api
function onJavascriptReady() {
  get('EventSourceStatusSpan').innerHTML = 'Connecting...';
  const events = new EventSource("events");
  events.onopen = function(event) {
    console.log("EventSource: connected");
    get('EventSourceStatusSpan').innerHTML = '<span style="color:#0a0">Connected</span>';
  }
  events.onerror = function(err) {
    console.log("EventSource: error");
    get('EventSourceStatusSpan').innerHTML = '<span style="color:#a00">Disconnected</span>';
  }
  events.onmessage = function(eventObj) {
    let event = JSON.parse(eventObj.data);
    if (event.data.type == 'ping') {
      console.log("got ping");
      return;
    }

    console.log(eventObj.data);
    let newEventHandler = null;
    if (event.data.type == 'stop') {
      newEventHandler = stopHandler;
    } else if (event.data.type == 'youtube') {
      newEventHandler = youtube;
    } else {
      panic("unknown event type: " + event.data.type);
    }

    if (currentEventHandler !== newEventHandler) {
      if (currentEventHandler) {
        currentEventHandler.disable();
      }
      currentEventHandler = newEventHandler;
    }
    currentEventHandler.handleEvent(event);
  }
}

</script>
<script src="https://www.youtube.com/iframe_api"></script>
</head><body>
<br/>
<h1 style="text-align:center">Stream Share</h1>

<div id="EventSourceStatusDiv" style="text-align:center">
  <span id="EventSourceStatusSpan">Loading...</span>
</div>

<div id="ErrorDiv"></div>
<div id="StageDiv">
  <div id="StageContentDiv">
  </div>
  <div id="YoutubePlayerDiv"></div>
</div>

<!-- if the page is in a separate tab, and another tab is selected, then this page will stop functioning -->
<div style="border:1px solid #aaa;margin:20px auto;padding:3px;text-align:center;width:450px"><h3>WARNING:</h3>Keep this page in its own Window, not in a tab with other pages.</div>

</body></html>
